1 概述
1.1 项目背景与意义
随着移动互联网与定位技术的深度融合，位置服务（LBS）已成为人们日常生活的核心组成部分。高德地图、百度地图、美团等移动应用，以及Foursquare、Swarm等专业位置服务平台，积累了海量用户签到数据，包含用户ID、POI ID、签到时间戳、地理位置等关键信息。这些数据为个性化下一地点（POI）推荐提供了坚实基础。
传统下一POI推荐方法主要依赖用户历史签到数据，仅关注局部序列模式，却忽略了三大核心因素：一是用户长期偏好与即时需求的动态平衡；二是时空上下文的强关联性（如早高峰的地铁站、夜间的餐厅）；三是POI间的全局转换规律（如“商场→餐厅”的高频连续访问模式）。这导致传统方法在短轨迹数据、不活跃用户冷启动等场景下推荐精度显著下降，难以满足用户个性化出行需求。
本项目基于GETNext模型构建端到端个性化下一地点推荐系统，具有重要的理论与工程意义：其一，融合全局轨迹模式与个性化偏好，提升推荐精准度；其二，推动Transformer与图神经网络（GCN）在时空推荐领域的工程化落地；其三，可广泛应用于导航、旅游规划、本地生活服务等场景，赋能产业发展。


1.2 主要内容
本课程设计围绕个性化POI推荐系统的全流程开发展开，核心内容包括：
	需求分析：明确系统的应用场景、性能指标与核心功能，为后续开发提供依据；
	数据集处理：基于Gowalla-CA公开数据集，完成数据收集、分析、清洗、标准化及轨迹流图构建；
	模型设计与搭建：深入理解GETNext模型原理，基于PyTorch实现包含GCN、Transformer的核心架构；
	算法实现与训练：配置训练环境，设置关键参数，采用分阶段训练策略完成模型训练与优化；
	系统集成：基于Streamlit构建交互式可视化界面，实现参数配置、模型推理与结果展示的集成；
	效果评估：设计功能与性能测试实验，对比模型与基线方法的性能，验证系统有效性。

2 需求分析
本系统面向三类核心应用场景，覆盖个人与商业需求：
	个人出行规划：为普通用户提供基于历史轨迹的下一地点推荐，如通勤用户的地铁站、餐厅推荐，旅游用户的景点推荐；
	本地生活服务：为美团、大众点评等平台提供商户推荐支持，结合用户时空偏好提升商户曝光率；
	城市交通管理：辅助交通部门分析用户移动规律，优化公共交通站点布局与运力调配。
场景约束：需支持海外坐标（如Gowalla-CA数据集的美国加州区域）可视化，适配不同设备（PC、平板）的访问需求。

3 数据集与数据预处理
3.1 数据集介绍
本设计采用Gowalla-CA公开数据集，配套高德地图POI属性补充数据，具体信息如下：
	核心数据集：Gowalla平台2009-2010年美国加州及内华达州的用户签到数据，包含21287条签到记录，涉及1024个用户、3856个POI；
	数据格式示例：
签到数据：user_id: 93, poi_id: 1024, timestamp: 1262304000, latitude: 37.802901, longitude: -122.448442
POI信息：poi_id: 1024, name: "Fisherman's Wharf", category: "Scenic Spot", address: "San Francisco, CA", business_hours: "08:00-18:00"
	数据规模：训练集17030条（80%）、验证集2129条（10%）、测试集2128条（10%）；
3.2 数据分析
对原始数据集进行统计分析，核心结论如下：
	用户行为分析：平均每个用户签到20.7次，其中62%的用户签到次数≤15次（属于不活跃用户），18%的用户轨迹长度≤3（短轨迹用户）；
	POI分布分析：POI主要集中在旧金山、洛杉矶等大城市，类别以餐饮（32%）、景点（28%）、交通枢纽（21%）为主；
	时空特征分析：签到高峰集中在7:00-9:00（早高峰）、12:00-14:00（午间）、18:00-20:00（晚高峰），符合用户出行规律；
	数据质量分析：原始数据存在3.2%的经纬度异常（超出加州范围）、1.8%的POI类别缺失，无重复签到记录。
3.3 预处理流程
基于数据分析结果，设计四步预处理流程：
	异常值处理：剔除时间戳异常（如未来时间）、经纬度异常（纬度32°-42°、经度-125°至-114°外）的数据，最终保留20621条有效签到记录；
	缺失值处理：POI类别缺失时按邻近（距离≤1km）POI类别填充，签到时间缺失时按用户平均访问间隔补全；
	数据标准化：时间戳转换为“小时-分钟”格式，按30分钟划分时间槽；经纬度统一为WGS84格式，保留6位小数；用户ID、POI ID转换为连续整数编码；
	轨迹处理与图构建：按24小时间隔拆分用户签到序列为独立轨迹，剔除单签到点轨迹；基于全量轨迹构建全局轨迹流图（节点为POI，边为连续访问关系，权重为访问频次）。
3.4 预处理结果
预处理后的数据质量与可用性显著提升：
	数据完整性：异常值与缺失值占比降至0.5%以下，满足模型训练需求；
	轨迹质量：保留有效轨迹8246条，平均轨迹长度4.2，短轨迹（长度≤3）占比降至11%；
	图结构质量：全局轨迹流图含3856个节点、12438条有向边，平均每个节点关联3.2条边，无孤立节点；
	适配性：标准化后的数据可直接输入GETNext模型，经Node2Vec降维后的POI嵌入维度为128，适配模型输入要求。

4 算法原理与思想
4.1 核心架构设计
GETNext模型的核心创新在于突破传统序列模型的局限，采用“全局轨迹流图+Transformer”双核心架构，整体分为五层：输入层、多维度编码层、融合层、输出层、转移注意力调整层，实现“全局模式捕捉-个性化特征学习-结果优化”的完整逻辑。其核心目标是同时利用所有用户的通用移动模式（全局）与单个用户的历史偏好（局部），提升短轨迹与冷启动场景的推荐精度。
 
4.2 关键组件原理
（1）全局轨迹流图（Trajectory Flow Map）
构建无用户依赖的加权有向图G=VEellw，节点V对应POI集合（含经纬度、类别等属性），边E表示POI间连续访问关系，边权重w为访问频次（近期访问权重提升1.5倍）。核心作用是捕捉通用移动模式（如“地铁站→写字楼”），为短轨迹用户提供推荐依据。
（2）GCN编码模块
采用3层谱图卷积网络（Spectral GCN）编码轨迹流图，通过邻域信息聚合更新POI嵌入：
\widetilde{L}=\left(D+I_N\right)^{-1}\left(A+I_N\right)
H^{\left(l\right)}=\sigma\left(\widetilde{L}H^{\left(l-1\right)}W^{\left(l\right)}+b^{\left(l\right)}\right)
其中D为度矩阵，I_N为单位矩阵，\sigma为Leaky ReLU激活函数（泄漏率0.2）。通过3层GCN堆叠（通道数32/64/128），最终输出包含全局转移模式的POI嵌入e_P。
（3）多维度编码层
GETNext模型通过多层编码实现多源信息融合，各编码层的核心实现方法如下：
	用户编码层：编码用户历史签到数据，两种主流实现方式：
	位置编码：将POI坐标转换为位置向量，通过RNN/Transformer编码序列特征；
	嵌入编码：将POI ID映射为嵌入向量，通过Transformer捕捉长距离依赖。
	时空编码层：编码当前位置与时间信息：
	位置编码：标准化经纬度坐标为向量，采用全连接层编码；
	时间编码：基于Time2Vec模型，将时间戳转换为包含周期性特征的向量，通过正弦激活函数捕捉昼夜、高峰等规律。
	POI编码层：编码POI属性信息：
	属性编码：将POI类别、名称等属性拼接为向量，经全连接层编码；
	嵌入编码：将POI ID映射为固定维度嵌入向量，融合签到频率等统计特征。
	全局轨迹流图编码层：编码图结构信息：
	图嵌入：使用LINE、Node2Vec等技术将POI节点转换为低维向量；
	图注意力：通过图注意力机制，动态关注与当前用户状态相关的POI节点。





（4）融合与输出层
采用多头注意力机制融合多维度编码结果，设计三个MLP解码器分别预测下一POI、访问时间、类别，通过加权损失函数优化： 
\mathcal{L}_{final}=\mathcal{L}_{poi}+10\times\mathcal{L}_{time}+\mathcal{L}_{cat}
（5）转移注意力图
显式建模POI间的转移概率，通过广播加法和元素-wise乘法融合节点特征与图拓扑信息：
\mathrm{\Phi}=\left(\mathrm{\Phi}_1\times1^\top+1\times\mathrm{\Phi}_2^\top\right)\odot\left(\bar{L}+J_N\right)
对最终推荐结果进行残差调整，强化全局轨迹模式的影响。
4.3 模型创新点
	全局与局部结合：轨迹流图捕捉通用模式，弥补传统模型仅关注单个用户局部序列的局限；
	时空深度融合：Time2Vec编码时间周期性，充分利用“POI类别-时间”关联（如“酒吧→夜间”）；
	灵活编码架构：各编码层支持多实现方式，可根据数据特性动态调整；
	Transformer优势：多头注意力机制自适应捕捉轨迹各节点贡献，优于RNN/LSTM的局部依赖建模。

5 算法实现
5.1 开发环境配置
类别	具体配置
开发工具	Jupyter Notebook、Anaconda、PyCharm
核心框架	PyTorch 1.10+（GPU加速）、Streamlit 1.30+（可视化）、torch-geometric（GCN支持）
依赖库	pandas、numpy、scikit-learn、tqdm、Node2Vec
5.2 核心参数设置
参数名称	取值	说明
POI/用户嵌入维度	128	平衡表征能力与计算效率
时间/类别嵌入维度	32	适配时间槽与POI类别数量
GCN层数/通道数	3层/32-64-128	逐步提升特征抽象度
Transformer配置	2层/2头/1024维前馈网络	适配小数据集，避免过拟合
优化器参数	Adam/1e-3/权重衰减5e-4	平衡收敛速度与稳定性
训练参数	批量20/轮数200/Dropout 0.3	适配GPU显存，防止过拟合
5.3 训练流程实现
采用分阶段训练策略，确保模型高效收敛：
	预训练阶段：使用Word2Vec预训练POI嵌入，初始化GCN层；冻结GCN层，仅训练Transformer编码器与解码器，学习用户偏好与时空特征（训练轮数80）；
	微调阶段：解冻GCN层，联合训练所有参数，融合全局轨迹模式；采用早停机制（验证集损失5轮不下降则停止），最终训练168轮后停止；
	数据增强：对训练集轨迹随机裁剪（保留长度≥3的子轨迹），扩充样本量至原始的1.5倍；
	正则化：全连接层添加L2正则化，GCN层采用Dropout（0.3），避免过拟合。
5.4 模型保存与加载
	模型保存：训练完成后，将GCN、Transformer、嵌入层等所有参数保存至./output/gowalla_exp_gpu/final_model_gpu.pth，文件大小约28MB；
	模型加载：推理时自动检测设备（GPU/CPU），通过map_location=device适配跨环境运行；加载时间≤2秒，满足实时推荐需求。



6 系统集成与效果评估
6.1 系统集成设计
基于模块化思想，将模型推理与可视化界面集成，形成完整系统：
	核心模块划分：数据层（数据集加载与预处理）、模型层（GETNext模型推理）、界面层（Streamlit可视化）、交互层（参数配置与事件响应）；
	集成逻辑：用户通过界面层输入参数→交互层传递参数至模型层→模型层调用数据层加载用户历史数据→推理后返回结果至界面层→展示表格与地图；
	优化措施：通过st.cache_resource.clear()清理缓存，解决Streamlit组件卡死问题；为双区域（主页面+侧边栏）组件添加唯一key，确保参数联动。
6.2 评估实验设计
	测试环境：Windows 10、NVIDIA RTX 3060 GPU、16GB内存，Python 3.9；
	测试数据集：Gowalla-CA测试集（2128条记录），含活跃用户、短轨迹用户、不活跃用户三类测试样本；
	基线模型：选择MF（矩阵分解）、LSTM（序列模型）、STAN（时空注意力模型）作为基线，确保对比公平性；
	测试内容：功能测试（参数配置、结果展示、异常处理）、性能测试（响应速度、精度指标）。
6.3 评估指标选择
采用推荐系统主流指标，全面评估模型性能：
	Acc@k（准确率）：前k个推荐结果中包含用户真实下一地点的比例，衡量推荐精准度；
	MRR（平均倒数排名）：真实结果排名倒数的平均值，衡量推荐结果的排序合理性；
	响应时间：从用户提交请求到结果展示的总时间，衡量系统交互性能；
	稳定性：连续100次请求的响应时间标准差，衡量系统可靠性。
6.4 算法效果对比与分析


（1）精度指标对比
模型	Acc@1	Acc@5	Acc@10	MRR
MF（基线）	1.10%	4.42%	7.23%	3.42%
LSTM（基线）	6.65%	13.06%	17.84%	12.01%
STAN（SOTA）	11.04%	23.48%	30.18%	18.69%
GETNext	13.57%	28.52%	35.90%	21.03%
	GETNext模型在所有指标上均显著优于基线模型，Acc@5较STAN提升5.04个百分点，验证了全局轨迹流图与Transformer融合架构的有效性；
	对不活跃用户（训练集轨迹数<13），Acc@10达43.94%，较STGN模型提升12.7个百分点，有效缓解冷启动问题；
	对短轨迹用户（轨迹长度<3），Acc@1达21.86%，较STGN提升14.63个百分点，证明全局轨迹模式对短轨迹场景的补充价值。

 


（2）关键场景性能
	短轨迹用户（长度≤3）：GETNext的Acc@1达21.86%，较STAN提升14.63个百分点，验证全局轨迹流图的有效性；
	不活跃用户（签到≤15次）：Acc@10达43.94%，较STAN提升12.7个百分点，缓解冷启动问题；
	响应速度：单用户请求响应时间≤2.3秒，批量10个请求响应时间≤5.8秒，满足性能需求；
	稳定性：连续100次请求响应时间标准差为0.21秒，系统运行稳定。
（3）结果分析
GETNext模型性能优势源于：其一，全局轨迹流图提供通用移动模式，弥补短轨迹用户信息不足；其二，Transformer捕捉长距离轨迹依赖，优于LSTM的局部建模；其三，时空特征深度融合，提升推荐精准度。系统集成后未出现性能损耗，交互体验良好。

7 总结与展望
7.1 设计总结
本课程设计完成了基于GETNext模型的个性化POI推荐系统的全流程开发，核心成果包括：
	完成需求分析与数据集处理，构建高质量的Gowalla-CA预处理数据集与全局轨迹流图；
	基于PyTorch实现GETNext模型，采用分阶段训练策略，模型精度优于主流基线方法；
	集成Streamlit可视化界面，实现双区域参数配置、表格与地图展示，支持异常处理；
	通过完整测试验证系统功能与性能，满足应用场景需求，具备工程实用性。



7.2 设计中遇到的问题及解决办法
技术问题	解决方案
数据集列名不匹配（KeyError）	适配POI编号列名node_name/poi_id，构建POI-经纬度/属性映射表
模型权重加载不匹配	保持训练与推理阶段模型结构一致（nn.Sequential+GCN），避免架构差异
Streamlit侧边栏交互无响应	清理缓存+组件唯一key+简化渲染逻辑，确保事件绑定正常
百度地图海外坐标失效	替换为Streamlit原生地图，适配WGS84坐标体系
numpy类型不可哈希（TypeError）	转换为Python原生int类型，通过flatten().tolist()处理数组维度
短轨迹推荐精度低	启用轨迹流图的全局模式，增强低信息密度轨迹的推荐依据

7.3 未来展望
	模型优化：完善GETNext全架构，集成时间-类别融合模块与转移注意力图；探索用户行为分类，定制专属轨迹流图；
	功能扩展：增加用户历史轨迹可视化、POI类别筛选、距离范围设置等个性化功能；
	部署升级：部署至云服务器，支持公网访问；优化推理速度，实现批量推荐与高并发处理；
	数据扩充：融合用户社交关系、POI评价等多源数据；适配国内数据集（如高德签到数据），拓展应用场景。



参考文献
[1] Yang S, Liu J, Zhao K. GETNext: Trajectory Flow Map Enhanced Transformer for Next POI Recommendation[C]//Proceedings of the 45th International ACM SIGIR Conference on Research and Development in Information Retrieval. 2022: 1-10.
[2] Luo Y, Liu Q, Liu Z. Stan: Spatio-temporal attention network for next location recommendation[C]//Proceedings of the Web Conference 2021. 2021: 2177-2185.
[3] Zhao P, Luo A, Liu Y, et al. Where to go next: A spatio-temporal gated network for next poi recommendation[J]. IEEE Transactions on Knowledge and Data Engineering, 2020.
[4] GETNext: Trajectory Flow Map Enhanced Transformer for Next POI Recommendation - arXiv
[5] GeoSAN: Geographical Self-Attention Networks for Spatial-Temporal POI Recommendation

